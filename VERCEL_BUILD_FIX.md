# Vercel Build Error Fix - ERR_MODULE_NOT_FOUND

## Problem
Getting 500 Internal Server Error in production with this error in Vercel logs:

```
Error [ERR_MODULE_NOT_FOUND]: Cannot find module '/var/task/dist/server/entry.mjs'
```

## Root Cause
The `vercel.json` file was **overriding** the Astro Vercel adapter's build configuration, causing incorrect output structure.

When using `@astrojs/vercel` adapter, you should **NOT** have a custom `vercel.json` file. The adapter handles all Vercel configuration automatically.

## Solution Applied ✅

**Deleted `vercel.json`** - The Vercel adapter now controls the build process completely.

### What Was Removed:

```json
{
  "buildCommand": "npm run build",
  "framework": "astro",
  "outputDirectory": "dist"
}
```

### Why This Caused the Error:

1. **vercel.json** told Vercel to look for output in `dist/`
2. **@astrojs/vercel** adapter creates output in `.vercel/output/`
3. Vercel couldn't find the files in the wrong location
4. Result: `ERR_MODULE_NOT_FOUND`

## How Vercel Adapter Works

The `@astrojs/vercel` adapter automatically:

1. ✅ Detects it's running on Vercel
2. ✅ Creates proper `.vercel/output/` structure
3. ✅ Bundles serverless functions correctly
4. ✅ Configures routes and static files
5. ✅ Sets up the correct Node.js runtime

**You don't need to configure anything manually!**

## Correct Project Structure

### With Vercel Adapter (✅ Correct):

```
blog.coregamehd.com/
├── astro.config.mjs          # Has adapter: vercel()
├── package.json
├── src/
└── .vercel/                  # Generated by adapter
    └── output/
        ├── functions/
        │   └── _render.func/
        ├── static/
        └── config.json
```

**No `vercel.json` needed!**

### With vercel.json (❌ Wrong):

```
blog.coregamehd.com/
├── astro.config.mjs
├── vercel.json              # ❌ Conflicts with adapter
├── package.json
└── dist/                    # ❌ Wrong output location
```

## Verification

### Local Build Test:

```bash
npm run build
```

Should show:
```
[@astrojs/vercel] Bundling function ../../../../dist/server/entry.mjs
[@astrojs/vercel] Copying static files to .vercel/output/static
[build] Server built in X.XXs
[build] Complete!
```

### Check Output Structure:

```bash
ls -la .vercel/output/
```

Should show:
```
config.json
functions/
static/
```

## Deployment Steps

### Step 1: Commit Changes

```bash
git add .
git commit -m "Fix Vercel build - remove vercel.json"
git push
```

### Step 2: Vercel Auto-Deploys

Vercel will automatically:
1. Detect the push
2. Run `npm run build`
3. Use the Vercel adapter's output
4. Deploy successfully ✅

### Step 3: Verify Deployment

1. Go to Vercel Dashboard → Deployments
2. Wait for build to complete (2-5 minutes)
3. Check build logs - should see no errors
4. Visit your site - should work!

## What to Expect in Vercel Logs

### ✅ Successful Build:

```
Running "npm run build"
...
[@astrojs/vercel] Bundling function
[@astrojs/sitemap] sitemap-index.xml created
[@astrojs/vercel] Copying static files
[build] Server built in X.XXs
[build] Complete!
```

### ❌ Failed Build (old error):

```
Error [ERR_MODULE_NOT_FOUND]: Cannot find module '/var/task/dist/server/entry.mjs'
```

## Vercel Project Settings

You **don't need** to configure these in Vercel dashboard:
- ❌ Build Command (auto-detected)
- ❌ Output Directory (handled by adapter)
- ❌ Install Command (auto-detected)
- ❌ Framework Preset (auto-detected as Astro)

You **only need** to set:
- ✅ Environment Variables (GITHUB_CLIENT_ID, etc.)
- ✅ Node.js Version (optional, defaults to 20)

## Environment Variables (Reminder)

Make sure these are set in Vercel:

```
GITHUB_CLIENT_ID=your_client_id
GITHUB_CLIENT_SECRET=your_client_secret
PUBLIC_SITE_URL=https://blog.coregamehd.com
```

## Troubleshooting

### Still getting build errors?

1. **Clear Vercel cache**:
   - Go to Vercel Dashboard → Deployments
   - Click "Redeploy" → Check "Clear cache and deploy"

2. **Check astro.config.mjs**:
   ```javascript
   import vercel from '@astrojs/vercel';
   
   export default defineConfig({
     output: 'server',
     adapter: vercel(),
     // ...
   });
   ```

3. **Verify package.json**:
   ```json
   {
     "dependencies": {
       "@astrojs/vercel": "^8.0.0",
       // ...
     }
   }
   ```

### Build succeeds but site doesn't work?

1. Check environment variables are set
2. Check Keystatic configuration
3. See `KEYSTATIC_PRODUCTION_FIX.md`

### Getting different error?

1. Check Vercel deployment logs
2. Look for the specific error message
3. Search Astro/Vercel documentation

## Best Practices

### ✅ Do:
- Use `@astrojs/vercel` adapter
- Let the adapter handle configuration
- Set environment variables in Vercel dashboard
- Keep `astro.config.mjs` simple

### ❌ Don't:
- Create `vercel.json` when using the adapter
- Manually configure build settings in Vercel
- Override the adapter's output directory
- Mix static and server output modes

## Summary

**Problem**: `ERR_MODULE_NOT_FOUND` in Vercel deployment  
**Cause**: `vercel.json` conflicting with Vercel adapter  
**Fix**: Delete `vercel.json` file  
**Result**: Vercel adapter handles everything automatically  
**Status**: ✅ Fixed and ready to deploy  

---

## Quick Checklist

Before deploying, verify:

- [ ] `vercel.json` is deleted
- [ ] `astro.config.mjs` has `adapter: vercel()`
- [ ] `output: 'server'` is set
- [ ] Environment variables are set in Vercel
- [ ] Local build works (`npm run build`)
- [ ] `.vercel/output/` directory exists after build

**All checked?** Push to GitHub and Vercel will deploy successfully! 🚀

---

**Your Vercel deployment should now work correctly!** The adapter will handle all the configuration automatically.
